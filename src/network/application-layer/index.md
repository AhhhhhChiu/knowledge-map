# 应用层 Application Layer

- [应用层原理](#应用层原理)
- Web & HTTP
- FTP
- Email
  - SMTP
  - POP3
  - IMAP
- DNS
- P2P应用
- CDN

## 应用层原理

### 可能的应用架构

- 客户端/服务器模式 C/S Client/Server
  - 服务器一直运行、有固定的IP和约定好的端口号，客户端主动与服务器通信
  - 客户端间歇性和服务器通信、可能是动态IP、不直接与其他客户端通信
  - 服务器可扩展性差、遇到性能瓶颈时服务能力断崖式下跌
- 对等模式 P2P Peer To Peer
  - 几乎没有一直运行的服务器
  - 任意端之间可以互相通信
  - 每一个节点既是服务器又是客户端，具有自扩展性：每新增一个peer带来新的服务能力和服务请求
  - 每个主机间歇性连接且IP可变，难以管理
- 混合模式
  - 多种服务模式混合，例如：[Napster](https://zhuanlan.zhihu.com/p/457122646)

### 进程通信

进程：在主机上进行的应用程序
- 客户端进程：发起通信的进程
- 服务器进程：等待连接的进程

### 分布式进程通信需要解决的问题

假设传输层已经具备了向远端传输数据的能力，此时我们将传输层当作一个黑盒来使用，应用层则可以只关心本层的内容

- [进程标识和寻址问题](#问题1对进程进行编址addressing)
- [传输层-应用层提供服务是如何](#问题2传输层提供的服务-需要穿过层间的信息)
  - 位置：层间界面的SAP （TCP/IP ：socket）
  - 形式：应用程序接口API （TCP/IP ：socket API）
- 如何使用传输层提供的服务，实现应用进程之间的报文交换，实现应用
  - 定义应用层协议：报文格式，解释，时序等
  - 编制程序，使用OS提供的API ，调用网络基础设施提供通信服务传报文，实现应用时序等

#### 问题1：对进程进行编址（addressing）

进程为了接受或发送报文，必须要有一个标识
- 主机：IP地址
- 协议：TCP or UDP
- 端口号

一些知名端口号的例子：
- HTTP: TCP 80
- Mail: TCP 25
- FTP: TCP 2

一个进程：用IP+port标示端节点，本质上，一对主机进程之间的通信由2个端节点构成

#### 问题2：传输层提供的服务

##### 需要穿过层间的信息

- 层间接口必须要携带的信息
  - 要传输的报文(SDU)
  - 谁传的(发送方应用进程标识：IP + TCP/UDP端口号)
  - 传给谁(接收方应用进程标识：IP + TCP/UDP端口号)
- 根据这些信息进行TCP报文段（UDP数据报）封装的传输层实体（tcp或者udp实体）

##### 层间信息的代表 TCP socket

Socket API 每次传输报文，在穿过层间时都需要携带很多信息(数据、源IP、源端口、目标IP、目标端口)，因此会在**本地**的一张表中存入一条信息，其中socket值就类似这条信息的一个主键，在操作系统中是一个整数

socket|源IP|源端口|目标IP|目标端口|状态
|-|-|-|-|-|-|
|...|...|...|...|...|...|

穿过层间时则不需要每次都携带全部信息，而只需要数据和socket两样东西，然后通过socket在表中找到这条信息，从而拿到源IP、源端口、目标IP、目标端口等信息进行传输报文

##### 层间信息的代表 UDP socket

UDP socket也是类似的做法，只是socket映射的信息只有源IP、源端口，因此UDP层间传输需要携带数据本身、socket、目标IP、目标端口


### 应用层协议

应用层协议定义了运行在不同端系统上的应用进程如何相互交换报文，具体包括

- 交换的报文类型：请求和应答报文
- 各种报文类型的语法：报文中的各个字段及其描述
- 字段的语义：即字段取值的含义
- 进程何时、如何发送报文及对报文进行响应的规则

应用协议仅仅是应用的一个组成部分，例如Web应用：HTTP协议，web客户端，web服务器，HTML

协议有公开和私有之分：

- 公开协议：由RFC文档定义、允许互操作
- 私有协议：协议不公开

### 应用需要传输层提供什么样的服务？

- 数据丢失率
- 延迟
- 吞吐
- 安全性

### Internet 传输层提供的服务

- TCP 服务
  - 可靠的传输服务
  - 流量控制：发送方不会淹没接受方
  - 拥塞控制：当网络出现拥塞时，能抑制发送方
  - 面向连接：要求在客户端进程和服务器进程之间建立连接
  - 不能提供的服务：时间保证、最小吞吐保证和安全
- UDP 服务
  - 不可靠数据传输
  - 不提供的服务：可靠，流量控制、拥塞控制、时间、带宽保证、建立连接

### UDP存在的必要性

- 能够区分不同的进程，而IP服务不能
- 无需建立连接，省去了建立连接时间，适合事务性的应用
- 不做可靠性的工作，例如检错重发，适合那些对实时性要求比较高而对正确性要求不高的应用
- 没有拥塞控制和流量控制，应用能够按照设定的速度发送数据

### 安全TCP

- TCP & UDP 都没有加密,明文通过互联网传输，甚至密码
- SSL 在TCP上面实现，提供加密的TCP连接
